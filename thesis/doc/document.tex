\documentclass{article}
  \parindent = 0mm % Sin sangría
  \usepackage[utf8]{inputenc}
  \usepackage[T1]{fontenc}
  \usepackage[spanish]{babel}
  \usepackage{graphicx}
  \usepackage{amstext}
  \usepackage{amsmath}
  \usepackage{amsthm}
  \usepackage{booktabs}
  \usepackage{subfigure}
  \usepackage{footnote}
  \usepackage{hyperref}
  \usepackage{algpseudocode,algorithm,algorithmicx}
  \usepackage[font=small,labelfont=bf]{caption}
  \usepackage{esvect}

  \newtheorem{definition}{Definición}
  \newtheorem{lemma}{Lema}

  \newcommand{\modelspace}{\hspace{1.5em}}

\begin{document}
  \begin{center}
    {\sc \large Maestría en Investigación de Operaciones}
    
    {\sc \large Tesis - Borrador}
    \linebreak

    {\rm Joaquín Correa - \today}
  \end{center}

  \section*{Problema}

  \subsection*{Descripción}

  El problema se ubica dentro del contexto de diseño y planificación de ciclovías en una ciudad.

  Dada una red que modela una ciudad y una matriz origen-destino con demanda asociada, el objetivo es maximizar la cantidad de demanda que utiliza la bicicleta como medio de transporte. Para poder lograr esto, se cuenta con infraestructuras y presupuesto, que de ser utilizados, permiten disminuir el costo percibido por el usuario al utilizar la bicicleta, asumiendo que utiliza el camino más corto, y por lo tanto potencialmente influir la decision de utilizarla como medio de transporte.

  \subsection*{Formulación}

  En este trabajo se presenta una formulación binivel del problema, donde el primer nivel representa la comuna (o entidad que toma decisiones sobre las ciclovías) y maximiza la cantidad de usuarios que utilizan la bicicleta por medio de la decisión de la ubicación y tipo de ciclovías para cada arco de la red. El segundo nivel representa a los usuarios y resuelve el problema del costo del camino más corto para cada par de nodos origen-destino.

  \subsection*{Formulación matemática}

  Sean los siguientes conjuntos y parámetros:

  \begin{description}
    \item[$OD$]: Conjunto de pares origen destino.
    \item[$G=(N,A)$]: Grafo dirigido que modela la red, con su conjunto de nodos $N$ y de arcos $A$. $A_n^+$ y $A_n^-$ son los conjuntos de arcos que salen y entran respectivamente desde el nodo $n$.
    \item[$I$]: Conjunto de infraestructuras de ciclovías.
    \item[$C_{ai}$]: Costo de usuario de atravesar el arco $a$ utilizando la infraestructura $i$. $C_{ai} \geq 0$.
    \item[$M_{ai}$]: Costo de construcción de la infraestructura $i$ en el arco $a$.
    \item[$B$]: Presupuesto para la construcción de infraestructuras.
    \item[$\theta_{nk}$]: Parámetro que vale $1$ si n es el origen del par origen-destino $k$, -$1$ si es el destino y $0$ en otro caso.
    \item[$w_k$]: Variable de primer nivel que contiene el valor del camino más corto para el par origen destino $k$.
    \item[$y_{ai}$]: Variable binaria de primer nivel que determina si la infraestructura $i$ está activa en el arco $a$.
    \item[$x_{ak}$]: Variable de segundo nivel que determina si el arco $a$ es parte del camino más corto para el par origen-destino $k$.
    \item[$f_k$]: Función que determina la demanda que utiliza la bicicleta como medio en función del costo del camino mas corto.
  \end{description}

  \begin{align}
    \text{max}    & \sum_{k \in OD} f_k(w_k)                                                         & \label{eq:objective1lvl} \\
    \text{s.t.}\; & w_k = \sum_{a \in A} \sum_{k \in OD} \sum_{i \in I} C_{ai}y_{ai}x_{ak}           & \forall k \in OD \label{eq:shortestpath} \\
                  & B \geq \sum_{a \in A} \sum_{i \in I} M_{ai}y_{ai}                                & \label{eq:respectbudget} \\
                  & 1 = \sum_{i \in I} y_{ai}                                                        & \forall a \in A \label{eq:alwaysoney} \\
                  & w_k \geq 0, y_{ai} \in \left\{ 0, 1 \right\}                                     & \nonumber \\
                  & \text{min} \sum_{a \in A} \sum_{k \in OD} \sum_{i \in I} C_{ai}y_{ai}x_{ak}      & \label{eq:subproblem} \\
                  & \text{s.t.} \sum_{a \in A_n^+} x_{ak} - \sum_{a \in A_n^-} x_{ak} = \theta_{nk}  & \forall n \in N, k \in OD \label {eq:flowbalance} \\
                  & \modelspace x_{ak} \geq 0                                                        & \nonumber
  \end{align}

  Donde:

  \begin{description}
    \item[\ref{eq:objective1lvl}]: La función objetivo es la suma de los valores de demandas que cambiaron de medio.
    \item[\ref{eq:shortestpath}]: Restricción que determina el costo del camino más corto dado en el primer nivel.
    \item[\ref{eq:respectbudget}]: Restricción de presupuesto sobre lo que se puede construir.
    \item[\ref{eq:alwaysoney}]: Restricción que requiere que una infraestructura estar activa en cada arco. Se discutirá más sobre esto en la siguiente sección.
    \item[\ref{eq:subproblem}]: Función objetivo del segundo nivel.
    \item[\ref{eq:flowbalance}]: Restricción de balance de flujo.
  \end{description}

  \subsubsection*{Observaciones}

  La linealidad de la formulación propuesta es determinada por las funciónes $f_k$. En las ecuaciones (\ref{eq:shortestpath}) y (\ref{eq:subproblem}) las variables de primer y segundo nivel se multiplican pero dado que las variables de un nivel son parámetro en el otro nivel no se pierde la linealidad de dichas ecuaciónes.

  En la formulación del problema de primer nivel, la restricción (\ref{eq:alwaysoney}) pudo haber sido escrita de manera que al menos una infraestructura esté activa. Esto se puede ver de diferentes maneras, pensando en la realidad modelada, un ciclista podría pasar prácticamente por cualquier calle sin problemas, entonces para que las instancias del modelo sean semánticamente correctas debería existir una infraestructura $i_0 \in I$ cuyo costo de construcción $M_{ai_0}$ sea 0 en todos de los arcos $a \in A$, mas allá de que el costo de usuario pueda ser altísimo. Desde un punto de vista formal, como se verá mas adelante, si no se requiere que en cada arco haya una infraestructura activa, entonces hay que agregar al problema de segundo nivel una restricción que evite que se activen flujos en arcos donde no hay infraestructura activa, es decir: $x_{ak} \leq \sum_{i \in I} y_{ai}, \forall a \in A, k \in OD$. Con esta restricción, el problema de segundo nivel puede no tener solución factible cuando las infraestructuras seleccionadas por el primer nivel no inducen un subgrafo que conectan todos los pares origen-destino.

  Se asumirá de aquí en adelante que las instancias del problema están bien definidas, esto significa que:

  \begin{enumerate}
    \item {$G$ es conexo}
    \item {$\forall k \in OD$ existe un camino $S_k$ con costo de construcción $\sum_{a \in S_k} M_{ei_0} = 0$}
  \end{enumerate}

  \subsection*{Validación de la formulación}

  Para discutir la validez del modelado se utilizará una formulación estándar de problema binivel o BLPP (Bi Level Programming Problem), como se puede encontrara en Bard (\ref{bardbook}).
  Sea la siguiente formulación simplificada del problema:

  \begin{align}
    \text{max}_{y \in Y}    & \; F(x, y) \\
    \text{s.t.} \modelspace & A_1 x + B_1 y \leq b_1 \\
                            & \text{min}_{x \in X} f(x, y) \\
                            & \modelspace A_2 x + B_2 y \leq b_2
  \end{align}

  Y las siguientes definiciones:

  \begin{definition}
    Conjunto factible
    \begin{align}
      S = \{(x, y) \setminus x \in X, y \in Y, A_1 x + B_1 y \leq b_1, A_2 x + B_2 y \leq b_2 \}
    \end{align}
  \end{definition}

  \begin{definition}
    Conjunto de reacción del segundo nivel:
    \begin{align}
      P(y) = \{ x \in \text{argmin}_{\hat{x} \in X} f(\hat{x}, y) : A_2 \hat{x} + B_2 y \leq b_2 \}
    \end{align}
  \end{definition}

  Diremos que el problema está bien formulado si el conjunto $S$ es no vacío, es decir, si existen soluciones factibles y si para toda $y$ el conjunto $P(y)$ es no vacío, es decir, si para todo movimiento del problema de primer nivel, hay margen de decisión en el segundo nivel.

  \begin{lemma}$S$ es no vacío
  \end{lemma}

  \begin{proof}
    $S \neq \emptyset$ ya que $\exists (x_0, y_0) \in X \times Y$ donde $y_0$ es el vector $y_{ai_0} = 1 \forall a \in A$, $i_0$ es la infraestructura cuyo costo $M_{ai_0} = 0$, lo que deja al resto de las entradas del vector $y_0$ en $0$. Por lo tanto se cumple las restricción (\ref{eq:alwaysoney}) dado que todos los arcos tienen una infraestructura activa, y la restricción (\ref{eq:respectbudget}) dado que el costo total de construcción de $y_0$ es $0$.

    Luego, dado que las infraestructuras activas logran la conectividad de los pares origen-destino y el hecho de que el el costo de los arcos $C_ai$ sea no negativo permite asegurar que el problema de segundo nivel tiene al menos una solución factible $x_0$.
  \end{proof}

  \begin{lemma}$\forall y \in Y,\; P(y) \neq \emptyset$
  \end{lemma}

  \begin{proof}
    Para cualquier asignación $y = \hat{y} \in Y$, se cumple que $P(\hat{y})$ es no vacío ya que todos los arcos tienen una infraestructura activa, por lo tanto el grafo donde los flujos del problema de segundo nivel pueden pasar es conexo y llega necesariamente a todos los nodos, incluyendo los pares origen-destino. Por lo tanto el espacio de soluciones factibles del subproblema es no vacío. 
  \end{proof}

  Aún cuando estas dos definiciones se cumplen, puede haber dificultades al encontrar la solución óptima cuando $P(y)$ contiene más de un elemento, caso en el cual el modelo puede no llegar a la solución óptima, dependiendo del valor $x \in P(y)$ que seleccione el problema de segundo nivel. En este caso de estudio esto es muy probable que suceda, puesto que pueden haber varios caminos más cortos entre dos puntos.

  \subsection*{Formulación alternativa de un nivel}

  Si bien la formulación binivel expresa de buena manera lo que se quiere resolver, en la práctica los BLPP son en general de dificil resolución. Por eso, antes de continuar con su el estudio, se analizará una formulación alternativa como LP de un nivel.

  Esta formulación nace de la formulación binivel quitando el subproblema y agregando sus restricciones al problema de primer nivel. El argumento para hacer esto es que las funciones $f_k$ deben ser decrecientes, entonces para maximizar $\sum_{j \in OD}f_k(w_k)$ lo mejor es los $w_k$ sean lo más chico posible.

  La formulación es la siguiente:

  \begin{align}
    \text{max}    & \sum_{k \in OD} f_k(w_k)                                                         & \label{eq:objectivealt} \\
    \text{s.t.}\; & w_k = \sum_{a \in A} \sum_{k \in OD} \sum_{i \in I} C_{ai}y_{ai}x_{ak}           & \forall k \in OD \label{eq:shortestpathalt} \\
                  & B \geq \sum_{a \in A} \sum_{i \in I} M_{ai}y_{ai}                                & \label{eq:respectbudgetalt} \\
                  & 1 = \sum_{i \in I} y_{ai}                                                        & \forall a \in A \label{eq:alwaysoneyalt} \\
                  & \sum_{a \in A_n^+} x_{ak} - \sum_{a \in A_n^-} x_{ak} = \theta_{nk}              & \forall n \in N, k \in OD \label{eq:flowbalancealt} \\
                  & w_k \geq 0, y_{ai} \in \{ 0, 1 \}, x_{ak} \geq 0                                 & \nonumber
  \end{align}

  \subsubsection*{Observaciones}

  Inicialmente se había planteado este mismo modelo pero con una función objetivo distinta. La idea era llevar la función objetivo de segundo nivel de la formulación inicial al primer nivel logrando una función multiobjetivo. Luego, como la unidad del primer nivel es unidades demanda y la del segundo nivel costo de usuario, se intentan unificar ambas multiplicando el primer nivel por el costo de usuario y el segundo por demanda quedando el siguiente objetivo: $min\;\sum_{k \in K} D_kw_k - f_k(w_k)w_k$. La idea es minimizar el costo del camino más corto $w_k$ y maximizar $f_k$ (minimizar el opuesto). Este planteo tiene la desventaja de tener la multiplicación de variables que seguramente sea posible circunvalar a razón de mayor complejidad de la formulación.

  \section*{Resolución del problema BLPP}

  Al igual que en su versión de un nivel, la mayoría de los avances en algorítmos de resolución se ha centrado en la versión lineal. Ya se ha demostrado en Bard (\ref{bardbook}) que el BLPP lineal es NP-Hard.

  \subsection*{Transformación de binivel a un nivel}

  Este problema se puede transformar a un problema de un nivel realizando unas transformaciones (cuales?), y de obtenerse una representación lineal se podría buscar alguna metodología exacta para resolverlo. La formulación binivel estudiada presenta el problema, a los efectos de la transformación, de contener ecuaciones con variables de diferentes niveles multiplicándose, dichas ecuaciones deben ser reformuladas para que no devengan en restricciones no lineales.

  \subsubsection*{Quitando multiplicación de variables}

  El objetivo es quitar la multiplicación entre $x_{ak}$ e $y_{ai}$. Se propone la formulación siguiente del problema de segundo nivel.

  \begin{align}
    \text{min}  & \sum_{k \in K} \sum_{a \in A} \sum_{i \in I} C_{ai} h_{aki}         & \label{eq:subproblemrefeq1} \\
    \text{s.t.} & \sum_{a \in A_n^+} x_{ak} - \sum_{a \in A_n^-} x_{ak} = \theta_{nk} & \forall n \in N, k \in OD \\
                & 0 \leq h_{aki} \leq y_{ai}                                          & \forall a \in A, k \in K, i \in I \\
                & x_{ak} = \sum_{i \in I} h_{aki}                                     & \forall a \in A, k \in K
  \end{align}

  Si utilizamos la ecuación (\ref{eq:subproblemrefeq1}) en la asignación de $w_k$ (ecuación \ref{eq:shortestpath}) el problema es equivalente (demostrar?) con la ventaja que no existan variables de diferentes niveles multiplicándose.

  \subsection*{Definición de las $f_k$s}

  Estas funciones fueron dejadas de lado en la formulación original para no ensuciar con detalles las primeras idas. Se analizan en esta sección diferentes alternativas de como implementarlas como un conjunto de ecuaciones lineales que se acoplaran a las formulación antedicha.

  Lo que deseamos de le una función $f_k$ es que pueda modelar una transición realista de la demanda entre sistemas de transporte. Realista, quiere decir, que aunque compleja, pueda expresar una transición tan paulatina como se quiera, que pueda parecerse a algo lineal, exponencial o lo que fuere. Asumiendo que las $f_k$ son decrecientes, la mejor forma que ocurriese es representarla como una sucesión decreciente de puntos de quiebre, tal que para cada uno se determine una cantidad de demanda transferida. Los puntos de quiebre son comparados contra el valor de $w_k$. Entonces sea $w_k$ fijo, la demanda transferida es:

  \begin{equation}
    \label{eq:deffks}
    f_k(w_k) = P_j,\; j = argmin_{j \in J} \{Q_j \geq w_k\}
  \end{equation}
  
  Donde $Q_j$ son los puntos de quiebre, $J$ es un conjunto índice y $P_j$ es la cantidad de demanda que se transfiere. Una ventaja de esta formulación es que puede ser integrada a la función objetivo de la formulación original de manera que la minimización queda en manos del objetivo del mismo problema.

  Como alternativas, se puede pensar en una simplificación de lo anterior, de manera que la demanda transferida sea toda o sea nada, para cada par origen-destino. Este enfoque si bien puede ser más simple de implementar, es muy poco realista. Otra alternativa es permitir que las funciones $f_k$ sean no lineales. Este enfoque puede llevar a soluciones analíticamente más precisas pero es sabido que aumenta considerablemente la dificultad de resolución práctica.

  Para modelar la función $argmin$ en una formulación como la que se viene trabajando es necesario utilizar variables de activación que solo permita que una entrada del índice esté activo. Por ejemplo si se usa $z_j,\; j \in J$, lo antedicho equivale a decir que $z_j \in \{0, 1\}$ y $\sum_{j \in J} z_j = 1$. Como estas restricciones se encuentran dentro de una maximización y suponiendo que el conjunto ordenado $Q$ es estrictamente decrecientes, podemos relajar la restricción de integralidad y sustituirla por $0 \leq z_j \leq 1$. Es esperable pensar que no pueden existir varios $z_j$ activos para la definición (\ref{eq:deffks}), porque si los hubiesen, al ser $Q$ un conjunto ordenado estrictamente decreciente entonces no se llegaría al máximo.

  \section*{Poniendo todo junto}

  Se escribe aquí las formulaciónes completas del problema en su forma binivel y su alternativa de un nivel, agregando las definiciones de $f_k$ y quitando la multiplicación de variables.

  \subsection*{Formulación binivel}

  Además de las definiciones en la formulación inicial (\ref{eq:objective1lvl})-(\ref{eq:flowbalance}):

  \begin{description}
    \item[$J$]: Es un conjunto índice utilizado en los conjuntos $P$ y $Q$.
    \item[$P_{kj}$]: Parámetro que determina la demanda transferida para el par origen-destino $k$ y el índice $j$.
    \item[$Q_{kj}$]: Parámetro que contiene el punto de quiebre para determinar la demanda transferida para el par origen-destino $k$ e índice $j$. 
    \item[$z_{kj}$]: Variable binaria que determina si demanda transferida para el par origen-destino $k$ es la de índice $j$.
    \item[$h_{aki}$]: Variable no negativa que determina el flujo que pasa por el arco $a$, para el par origen-destino $k$ utilizando la infraestructura $i$. 
  \end{description}

  \begin{align}
    \text{max}    & \sum_{k \in OD} \sum_{j \in J} P_{kj} z_{kj}                                     & \label{eq:objective1lvlfinal} \\
    \text{s.t.}\; & w_k = \sum_{a \in A} \sum_{i \in I} C_{ai}h_{aki}                                 & \forall k \in OD \label{eq:shortestpathfinal} \\
                  & Q_{kj} z_{kj} \geq w_k                                                           & \forall j \in J, k \in OD \label{eq:breakpoints} \\
                  & \sum_{j \in J} z_{kj} = 1                                                        & \forall k \in OD \label{eq:singularbreakpoint} \\
                  & B \geq \sum_{a \in A} \sum_{i \in I} M_{ai}y_{ai}                                & \label{eq:respectbudgetfinal} \\
                  & 1 = \sum_{i \in I} y_{ai}                                                        & \forall a \in A \label{eq:alwaysoneyfinal} \\
                  & w_k \geq 0, y_{ai} \in \{ 0, 1\}, 0 \leq z_{kj} \leq 1                           & \nonumber \\
                  & \text{min} \sum_{k \in K} \sum_{a \in A} \sum_{i \in I} C_{ai} h_{aki}           & \label{eq:subproblemfinal} \\
                  & \text{s.t.} \sum_{a \in A_n^+} x_{ak} - \sum_{a \in A_n^-} x_{ak} = \theta_{nk}  & \forall n \in N, k \in OD \label{eq:flowbalancefinal} \\
                  & \modelspace x_{ak} = \sum_{i \in I} h_{aki}                                      & \forall a \in A, k \in K \label{eq:flowactivation} \\
                  & \modelspace 0 \leq h_{aki} \leq y_{ai}                                           & \forall a \in A, k \in K, i \in I \label{eq:respectinfra} \\
                  & \modelspace x_{ak} \geq 0, h_{aki} \geq 0                                        & \forall a \in A, k \in K \nonumber
  \end{align}

  Donde las nuevas ecuaciones son:

  \begin{description}
    \item[\ref{eq:objective1lvlfinal}]: Función que suma los valores de demanda transferida $P_{kj}$ activos.
    \item[\ref{eq:breakpoints}]: Restricción que determina que los puntos de quiebre activos son aquellos cuyo costo es menor o igual al del camino más corto.
    \item[\ref{eq:singularbreakpoint}]: Restricción que permite solo un punto de quiebre activo para cada par origen-destino $k$.
    \item[\ref{eq:flowactivation}]: El flujo total para el arco $a$ y el par origen-destino $k$ es la suma de los flujos de todos las infraestructuras.
    \item[\ref{eq:respectinfra}]: El flujo por el arco $a$, para el par origen-destino $k$ y la infraestructura $i$ puede estar activo si la infraestructura $i$ esta activa.  
  \end{description}

  \subsection*{Formulación de un nivel}

  \begin{align}
    \text{max}    & \sum_{k \in OD} \sum_{j \in J} P_{kj} z_{kj}                                           & \label{eq:objectivealtfinal} \\
    \text{s.t.}\; & w_k = \sum_{a \in A} \sum_{i \in I} C_{ai}h_{aki}                                       & \forall k \in OD \label{eq:shortestpathaltfinal} \\
                  & Q_{kj} z_{kj} \geq w_k                                                                 & \forall j \in J, k \in OD \label{eq:breakpointsalt} \\
                  & \sum_{j \in J} z_{kj} = 1                                                              & \forall k \in OD \label{eq:singularbreakpointalt} \\
                  & B \geq \sum_{a \in A} \sum_{i \in I} M_{ai}y_{ai}                                      & \label{eq:respectbudgetaltfinal} \\
                  & 1 = \sum_{i \in I} y_{ai}                                                              & \forall a \in A \label{eq:alwaysoneyaltfinal} \\
                  & \sum_{a \in A_n^+} x_{ak} - \sum_{a \in A_n^-} x_{ak} = \theta_{nk}                    & \forall n \in N, k \in OD \label{eq:flowbalancealt} \\
                  & x_{ak} = \sum_{i \in I} h_{aki}                                            & \forall a \in A, k \in K \label{eq:flowactivationalt} \\
                  & 0 \leq h_{aki} \leq y_{ai}                                                 & \forall a \in A, k \in K, i \in I \label{eq:respectinfraalt} \\
                  & 0 \leq z_{kj} \leq 1                                                                   & \nonumber \\
                  & w_k \geq 0, y_{ai} \in \{ 0, 1 \}, x_{ak} \geq 0, h_{aki} \geq 0                       & \nonumber
  \end{align}

  Donde las definiciones de conjuntos, parámetros y variables son equivalentes a la formulación (\ref{eq:objective1lvlfinal})-(\ref{eq:respectinfra}).

  \section*{Implementación}

  \subsection*{Versión de un nivel}

  Durante la implementación de este modelo en un solver la restricción (\ref{eq:breakpointsalt}) demostró particular complejidad. Para explicar esto primero debemos analizar como calcular una $f_k$ de manera aislada. Podemos utilizar la siguiente formulación fácilmente implementable, dado un $W$ fijo:

  \begin{align}
    f(W) =\; & max \sum_{j \in J} P_j y_j    & \\
             & s.t. \sum_{j \in J} y_i = 1   & \label{eq:fkproblematiceq} \\
             & \;\;\; Q_j \geq W y_j         & \forall j \in J \\
             & \;\;\; y_i \in {0,1}          &
  \end{align}

  El problema con esta formulación es que para integrarla a (\ref{eq:objective1lvlfinal})-(\ref{eq:respectinfra}) el parámetro $W$ no debe multiplicar otras variables. Una versión mas compleja que logra circunvalar esta situación es, agregando dos variables $w^{aux}_j$ y $w^{sink}_j$. La idea es utilizar $w^{aux}_j$ en lugar de $W$ en la restricción (\ref{eq:fkproblematiceq}) quitando la multiplicación por $y_i$, y que esta valga $W$ o 0 dependiendo de si $y_i$ está activa. Para activar $y_i$ se agrega las restricciónes (\ref{eq:yactivation1}) y (\ref{eq:yactivation2}) utilizado un parámetro $M$ cuyo valor sea muy grande y finalmente la restricción (\ref{eq:assignwauxsink}) para lograr la asignación del valor de $W$ a $w^{aux}_j$ o $w^{sink}_j$.

  \begin{align}
    f(W) =\; & max \sum_{j \in J} P_j y_j           & \label{eq:impldetfkobj}\\
             & s.t. \sum_{j \in J} y_i = 1          & \\
             & \;\;\; Q_j \geq w^{aux}_j            & \forall j \in J \label{eq:implfkoriginalineq} \\
             & \;\;\; w^{aux}_j \leq M y_j          & \forall j \in J \label{eq:yactivation1} \\
             & \;\;\; w^{sink}_j \leq M (1 - y_j)   & \forall j \in J \label{eq:yactivation2} \\
             & \;\;\; w^{aux}_j + w^{sink}_j = W    & \forall j \in J \label{eq:assignwauxsink} \\
             & \;\;\; y_i \in {0,1}                 & \\
             & \;\;\; w^{aux}_j, w^{sink}_j \geq 0  & \label{eq:impldetfklast}
  \end{align}

  Esta formulación funcionó bien en el modelo final a los efectos de calcular correctamente las funciones $f_k$, pero sucedió que el modelo carecía de incentivos para seguir mejorando los costos de los flujos una vez pasado cierto punto de quiebre $Q_{kj}$, esto se observó en algunas situaciones en que los valores de los flujos no eran unitarios y el costo del camino mas corto era igual al de algún punto de quiebre $Q_{kj}$. Para solucionar esto, se agregó otra variable, $r_{kj} \geq 0$ que modela la diferencia entre el punto de quiebre $Q_{kj}$ activo y el costo del camino mas corto $w_k$. Luego se agregó dicha variable a la función objetivo de manera que se incentivar el crecimiento de esta variable. La ecuación (\ref{eq:implfkoriginalineq}), que en el modelo final agrega los indices por par origen-destino $k$, quedó entonces de esta manera:

  \begin{equation}
    Q_{kj} z_{kj} - r_{kj} = w^{aux}_j
  \end{equation}

  Luego, la función objetivo:

  \begin{equation}
    \sum_{k \in OD} \sum_{j \in J} P_{kj}z_{kj} + r_{kj}
  \end{equation}

  La relajación de la integralidad de las variables $z_{kj}$, como se menciona en la sección de definición de $f_k$ no fue considerada ya que en la práctica la hipótesis planteada no sucede a menos que el valor de $w_k$ sea exactamente igual a uno de los puntos de quiebre.

  \section*{Referencias}

  \begin{enumerate}
    \item{\label{bardbook} Jonathan F. Bard (1998). Practical Bilevel Optimization, Algorithms and Applications}
  \end{enumerate}
\end{document}
