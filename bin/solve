#!/bin/sh

# Take models from exact foleder. To override the model loaded
# specify the name without extension in the BCNETWORK_MODEL_NAME variable
#

set -e

echo_err() {
    echo $1 >&2
}

run_ampl() {
    model_file=$1
    data_file=$2
    output_file=$3

    split_line=$(grep -n "solve;" $model_file | cut -f1 -d ':')
    ampl_file=$(mktemp --suffix .ampl)
    ampl_model_file=$(mktemp --suffix .mod)

    # Build ampl model file (everything except what's below solve)
    head -n $(echo "$split_line - 1" | bc) $model_file > $ampl_model_file

    # Build ampl file
    echo "model '$ampl_model_file';" > $ampl_file
    echo "data '$data_file';" >> $ampl_file
    echo "option solver cplex;" >> $ampl_file

    if [ -n "$BCNETWORK_TIMEOUT" ]; then
        echo "option timelimit $BCNETWORK_TIMEOUT;" >> $ampl_file
    fi

    if [ -n "$BCNETWORK_MAX_MEM_MB"]; then
        echo "option treememlim $BCNETWORK_MAX_MEM_MB;" >> $ampl_file
    fi

    echo "solve;" >> $ampl_file

    # Print results part
    tail -n +$(echo "$split_line + 1" | bc) $model_file >> $ampl_file

    ampl $ampl_file | tee $output_file
}

if [ -z "$1" -o -z "$2" ]; then
  echo_err "Usage:"
  echo_err "solve <data_file> <output_file>"
  exit 1
fi

solver=${BCNETWORK_SOLVER:-cbc}
parallelism=${BCNETWORK_PARALLELISM:-10}
model_name=${BCNETWORK_MODEL_NAME:-single_level}
model_file=exact/$model_name.mod

if [ ! -f $model_file ]; then
  echo_err "Model file $model_file does not exist"
  exit 2
fi

if [ $solver = 'cbc' ]; then
    # Need to build cbc:
    # coinbrew fetch Cbc@2.10.5 && coinbrew build -j4 Cbc --with-glpk --enable-cbc-parallel
    #
    if [ -n "$BCNETWORK_TIMEOUT" ]; then
        cbc_timeout="-seconds $BCNETWORK_TIMEOUT"
    fi

    cbc $model_file%$1 -thread $parallelism $cbc_timeout -solve -gsolu $(mktemp) | tee $2
elif [ $solver = 'glpsol' ]; then
    if [ -n "$BCNETWORK_TIMEOUT" ]; then
        glpsol_timeout="--tmlim $BCNETWORK_TIMEOUT"
    fi
    glpsol -m $model_file -d $1 $glpsol_timeout | tee $2
elif [ $solver = 'ampl' ]; then
    run_ampl $model_file $1 $2
else
    echo_err "Solver must be one of cbc|glpsol|ampl"
    exit 3
fi
